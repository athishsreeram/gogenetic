package main

import (
	"gogenetic/gogexec"
	"gogenetic/gogfile"
	"log"
	"os"

	"io/ioutil"

	"flag"

	"github.com/BurntSushi/toml"
)

// AutoGeneratedCli Create & copied from https://xuri.me/toml-to-go/
type AutoGeneratedCli struct {
	Gogenetic struct {
		Apiname              string `toml:"Apiname"`
		TomlDir              string `toml:"TomlDir"`
		Tomlesread           string `toml:"Tomlesread"`
		Escqrsread           string `toml:"Escqrsread"`
		Esreadoutput         string `toml:"Esreadoutput"`
		Eventstorereadoutput string `toml:"eventstorereadoutput"`
		Cudoutput            string `toml:"Cudoutput"`
		Escqrscud            string `toml:"Escqrscud"`
		Dir                  string `toml:"Dir"`
		OutDir               string `toml:"outDir"`
		Cud                  string `toml:"Cud"`
		Read                 string `toml:"Read"`
		Eventsource          string `toml:"Eventsource"`
		Crud                 string `toml:"Crud"`
		Crudoutput           string `toml:"Crudoutput"`
		Eswithoutcqrsoutput  string `toml:"Eswithoutcqrsoutput"`
		Eswithoutcqrs        string `toml:"Eswithoutcqrs"`
	} `toml:"Gogenetic"`
	API struct {
		Name string `toml:"Name"`
	} `toml:"API"`
}

func main() {

	dir, err := os.Getwd()
	if err != nil {
		log.Fatal(err)
	}

	//0. Argument Options Simple CLI with go-command-line-flags
	tomlFile := flag.String("tomlFile", dir+"/toml/test.toml", " Input the TOML File.")
	archType := flag.String("archType", "crud", "Architechture Type")
	outDir := flag.String("outDir", "output", " Input the TOML File.")
	flag.Parse()

	//go run gogentic.go /Users/anharay/go/src/gogenetic/toml/test.toml /Users/anharay/go/src/gogenetic/template/grpctemplate.goproto
	//1. Load TOML file
	tomlData, err := ioutil.ReadFile(*tomlFile)
	if err != nil {
		log.Fatal(err)
	}
	//log.Print("Parsed TOML")
	//log.Print(string(tomlData))

	//2. Set value
	var conf AutoGeneratedCli

	//3. Parse & Load value dynamically from given input toml
	//log.Print("Parsed & Load value into Generated Structs from Create & copied from https://xuri.me/toml-to-go/")
	var confToml AutoGeneratedCli
	if _, err := toml.Decode(string(tomlData), &confToml); err != nil {
		log.Fatal(err)
	}

	conf.Gogenetic.Apiname = confToml.API.Name
	conf.Gogenetic.TomlDir = *tomlFile
	conf.Gogenetic.Dir = ""
	conf.Gogenetic.OutDir = *outDir

	//4. Set Value to the CLI Stucts input
	if *archType == "es-cqrs" {

		conf.Gogenetic.Tomlesread = "/toml/eventstore-read.toml"
		conf.Gogenetic.Escqrsread = "go/es-cqrs-read/"
		conf.Gogenetic.Escqrscud = "go/es-cqrs-cud/"
		conf.Gogenetic.Esreadoutput = *outDir + "/es-read-output"
		conf.Gogenetic.Eventstorereadoutput = *outDir + "/eventstore-read-output"
		conf.Gogenetic.Cudoutput = *outDir + "/es-cud-output"

	}

	if *archType == "es-async-cqrs" {

		conf.Gogenetic.Tomlesread = "/toml/eventstore-read.toml"
		conf.Gogenetic.Escqrsread = "go/es-cqrs-read/"
		conf.Gogenetic.Escqrscud = "go/es-cqrs-cud/"
		conf.Gogenetic.Esreadoutput = *outDir + "/es-read-output"
		conf.Gogenetic.Eventstorereadoutput = *outDir + "/eventstore-read-output"
		conf.Gogenetic.Cudoutput = *outDir + "/es-cud-output"
		conf.Gogenetic.Read = "True"
		conf.Gogenetic.Cud = "True"
		conf.Gogenetic.Eventsource = "True"

	}

	if *archType == "es-async-cqrs-read" {

		conf.Gogenetic.Tomlesread = "/toml/eventstore-read.toml"
		conf.Gogenetic.Escqrsread = "go/es-cqrs-read/"
		conf.Gogenetic.Escqrscud = "go/es-cqrs-cud/"
		conf.Gogenetic.Esreadoutput = *outDir + "/es-read-output"
		conf.Gogenetic.Eventstorereadoutput = *outDir + "/eventstore-read-output"
		conf.Gogenetic.Cudoutput = *outDir + "/es-cud-output"
		conf.Gogenetic.Read = "True"
		conf.Gogenetic.Cud = "Flase"
		conf.Gogenetic.Eventsource = "Flase"

	}

	if *archType == "es-cqrs-eventstore-read" {

		conf.Gogenetic.Tomlesread = "/toml/eventstore-read.toml"
		conf.Gogenetic.Escqrsread = "go/es-cqrs-read/"
		conf.Gogenetic.Escqrscud = "go/es-cqrs-cud/"
		conf.Gogenetic.Esreadoutput = *outDir + "/es-read-output"
		conf.Gogenetic.Eventstorereadoutput = *outDir + "/eventstore-read-output"
		conf.Gogenetic.Cudoutput = *outDir + "/es-cud-output"
		conf.Gogenetic.Read = "False"
		conf.Gogenetic.Cud = "Flase"
		conf.Gogenetic.Eventsource = "True"

	}

	if *archType == "es-async-cqrs-cmd-event-handler-cud" {

		conf.Gogenetic.Tomlesread = "/toml/eventstore-read.toml"
		conf.Gogenetic.Escqrsread = "go/es-cqrs-read/"
		conf.Gogenetic.Escqrscud = "go/es-cqrs-cud/"
		conf.Gogenetic.Esreadoutput = *outDir + "/es-read-output"
		conf.Gogenetic.Eventstorereadoutput = *outDir + "/eventstore-read-output"
		conf.Gogenetic.Cudoutput = *outDir + "/es-cud-output"
		conf.Gogenetic.Read = "False"
		conf.Gogenetic.Cud = "True"
		conf.Gogenetic.Eventsource = "False"

	}

	if *archType == "es-async-cmdhandler-cqrs" {

		conf.Gogenetic.Escqrscud = "go/es-cqrs-cud/"
		conf.Gogenetic.Cudoutput = *outDir + "/es-cmdhandler-cud-output"

	}

	if *archType == "es-async-eventhandler-cqrs" {

		conf.Gogenetic.Escqrscud = "go/es-cqrs-cud/"
		conf.Gogenetic.Cudoutput = *outDir + "/es-eventhandler-cud-output"

	}

	if *archType == "crud" {

		conf.Gogenetic.Crud = "go/"
		conf.Gogenetic.Crudoutput = *outDir + "/crud"

		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"proto-grpcresttemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"servicecrudtemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"grpcservertemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"grpcrestservertemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"cmdservertemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"grpcclienttemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"xormdomaintemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"configtemplate.tpl", conf.Gogenetic.Crudoutput)
		gogfile.CreateFile(*tomlFile, conf.Gogenetic.Crud+"devconftemplate.tpl", conf.Gogenetic.Crudoutput)

		gogexec.MoveTo(conf.Gogenetic.Crudoutput)
		grpcargs := []string{"--proto_path=proto", "-I/usr/local/include", "-I.", "-I" + os.Getenv("GOPATH") + "/src", "-I" + os.Getenv("GOPATH") + "/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis", "--go_out=plugins=grpc:proto", conf.Gogenetic.Apiname + "-service.proto"}
		gogexec.ExecuteProtoCmd(grpcargs)

		grpcgatewayargs := []string{"--proto_path=proto", "-I/usr/local/include", "-I.", "-I" + os.Getenv("GOPATH") + "/src", "-I" + os.Getenv("GOPATH") + "/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis", "--grpc-gateway_out=logtostderr=true:proto", conf.Gogenetic.Apiname + "-service.proto"}
		gogexec.ExecuteProtoCmd(grpcgatewayargs)

		grpcswaggerargs := []string{"--proto_path=proto", "-I/usr/local/include", "-I.", "-I" + os.Getenv("GOPATH") + "/src", "-I" + os.Getenv("GOPATH") + "/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis", "--swagger_out=logtostderr=true:proto", conf.Gogenetic.Apiname + "-service.proto"}
		gogexec.ExecuteProtoCmd(grpcswaggerargs)
	}

	if *archType == "es-without-cqrs" {

		conf.Gogenetic.Eswithoutcqrs = "go/"
		conf.Gogenetic.Eswithoutcqrsoutput = *outDir + "/es-without-cqrs"

	}

}
