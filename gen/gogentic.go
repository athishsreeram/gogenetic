package main

import (
	"fmt"
	"html/template"
	"log"
	"os"

	"io/ioutil"

	"github.com/BurntSushi/toml"

	"flag"
	"strings"
)

var fns = template.FuncMap{
	"plus1": func(x int) int {
		return x + 1
	}, "minus1": func(x int) int {
		x = x - 1
		return x
	}, "convert": func(x string) string {
		if x == "int" {
			return "integer"
		}
		return ""
	}, "lowercase": func(x string) string {
		return strings.ToLower(x)
	},
}

// Create & copied from https://xuri.me/toml-to-go/

type AutoGenerated struct {
	API struct {
		Name       string `toml:"Name"`
		Operations []struct {
			URL         string `toml:"url"`
			Request     string `toml:"request"`
			Response    string `toml:"response"`
			Protocol    string `toml:"protocol"`
			Operationid string `toml:"operationid"`
		} `toml:"Operations"`
	} `toml:"API"`
	Models struct {
		Model []struct {
			Name     string `toml:"name"`
			Variable []struct {
				Name  string `toml:"name"`
				Value string `toml:"value"`
				Type  string `toml:"type"`
			} `toml:"Variable"`
		} `toml:"Model"`
	} `toml:"Models"`
}

// Create & copied from https://xuri.me/toml-to-go/

func check(e error) {
	if e != nil {
		panic(e)
	}
}

func main() {

	os.Chdir("../")

	dir, err := os.Getwd()
	if err != nil {
		log.Fatal(err)
	}
	fmt.Println(dir)

	//0. Argument Options Simple CLI with go-command-line-flags
	tomlFile := flag.String("tomlFile", dir+"/toml/test.toml", " Input the TOML File.")
	templateFile := flag.String("templateFile", dir+"/template/grpctemplate.goproto", " Input the TOML File.")
	flag.Parse()

	//go run gogentic.go /Users/anharay/go/src/gogenetic/toml/test.toml /Users/anharay/go/src/gogenetic/template/grpctemplate.goproto
	//1. Load TOML file
	tomlData, err := ioutil.ReadFile(*tomlFile)
	check(err)
	log.Print("Parsed TOML")
	log.Print(string(tomlData))

	//2. Load Template
	tmpl, err := ioutil.ReadFile(*templateFile)
	check(err)
	log.Print("Parsed Template")
	log.Print(string(tmpl))

	//3. Parse & Load value dynamically
	var conf AutoGenerated
	if _, err := toml.Decode(string(tomlData), &conf); err != nil {
		log.Fatal(err)
	}
	log.Print("Parsed & Load value into Generated Structs from Create & copied from https://xuri.me/toml-to-go/")
	log.Printf("title: %s", conf.Models.Model[0].Name)

	log.Print("Create a goTemplate and Pass TOML struts Value to create the final grpc file")
	//4. Create Template and Pass TOML Value
	t := template.New("GRPC template")

	t1, err := t.Funcs(fns).Parse(string(tmpl))
	if err != nil {
		log.Fatal("Parse: ", err)
		return
	}

	err = t1.Execute(os.Stdout, conf)
	if err != nil {
		log.Fatal("Execute: ", err)
		return
	}

}
